# 奶味蓝蓝的数据库初学笔记

## DELIMITER 语法

`DELIMITER` 用于更改 MySQL 的语句结束符，使得 MySQL 能够正确解析存储过程、函数、触发器等复杂的 SQL 代码。

### 语法

```sql
DELIMITER new_delimiter
```

- `new_delimiter`：新定义的语句结束符，可以是 `//`、`$$` 等任意字符或字符串。
- 结束后通常需要将结束符恢复为分号（`;`）：

```sql
DELIMITER ;
```

### 用法
在定义存储过程、函数或触发器时，需要使用 `DELIMITER` 来避免 MySQL 在遇到分号时错误地认为语句结束。

### 示例

```sql
DELIMITER //
CREATE PROCEDURE ExampleProcedure()
BEGIN
    SELECT 'Hello, World!';
END //
DELIMITER ;
```

# 创建存储过程（CREATE PROCEDURE）

### 语法

```sql
CREATE PROCEDURE procedure_name([IN|OUT|INOUT] param_name data_type, ...)
BEGIN
    -- SQL statements
END
```

- `procedure_name`：存储过程的名称。
- 参数类型：
  - **`IN`**：输入参数，调用者传入的值。
  - **`OUT`**：输出参数，存储过程返回的结果。
  - **`INOUT`**：既可作为输入参数，又可作为输出参数。
- **`BEGIN ... END`**：包含存储过程的主体，包含一个或多个 SQL 语句。

### 示例
创建一个带输入和输出参数的存储过程：

```sql
DELIMITER //
CREATE PROCEDURE AvgCourseScore(IN course_id CHAR(5), OUT avg_score FLOAT)
BEGIN
    SELECT AVG(Grade) INTO avg_score FROM SC WHERE Cno = course_id;
END //
DELIMITER ;
```

# 调用存储过程（CALL）

### 语法

```sql
CALL procedure_name([parameter1, parameter2, ...]);
```

- `procedure_name`：要调用的存储过程的名称。
- 参数：根据存储过程定义传入输入（`IN`）、输出（`OUT`）、或输入输出（`INOUT`）参数。`OUT` 和 `INOUT` 参数需要使用会话变量来存储返回值，如 `@var`。

### 示例
调用不带参数的存储过程：

```sql
CALL ConvertScoreToGrade();
```

调用带输入和输出参数的存储过程：

```sql
CALL AvgCourseScore('YN002', @avg_score);
SELECT @avg_score AS 'Average Score';
```

# MySQL 聚合函数

MySQL 提供了一些用于统计和计算的聚合函数，类似于 `AVG`，主要用于汇总数据。

### 常用聚合函数

- **`AVG(column_name)`**：计算列的平均值。
  
  ```sql
  SELECT AVG(Grade) FROM SC WHERE Cno = 'YN001';
  ```

- **`SUM(column_name)`**：计算列的总和。
  
  ```sql
  SELECT SUM(Grade) FROM SC WHERE Cno = 'YN001';
  ```

- **`COUNT(column_name)`**：统计列中非空值的数量。
  
  ```sql
  SELECT COUNT(Sno) FROM SC WHERE Cno = 'YN001';
  ```

- **`MAX(column_name)`**：返回列的最大值。
  
  ```sql
  SELECT MAX(Grade) FROM SC WHERE Cno = 'YN001';
  ```

- **`MIN(column_name)`**：返回列的最小值。
  
  ```sql
  SELECT MIN(Grade) FROM SC WHERE Cno = 'YN001';
  ```

## 小节总结

- **`DELIMITER`**：用于临时更改结束符，确保 MySQL 能正确解析存储过程或其他复杂结构。
- **`CREATE PROCEDURE`**：用于定义存储过程，支持输入、输出和双向参数。
- **`CALL`**：用于调用存储过程，可带参数或不带参数。
- **聚合函数**（如 `AVG`, `SUM`, `COUNT`, `MAX`, `MIN`）：用于数据统计和汇总，是 MySQL 中常用的计算工具。

 
## Python 与 MySQL 的连接和嵌入式 SQL 操作

## 步骤 1：导入必要的库

```python
import pandas as pd
from sqlalchemy import create_engine
import os
import json
from sqlalchemy.exc import SQLAlchemyError
```

- `pandas` 用于读取和处理 CSV 数据。
- `sqlalchemy` 提供与数据库连接的功能。
- `os` 用于从环境变量中读取数据库 URI。
- `json` 用于将数据转换为 JSON 格式，以便在数据库中存储。
- `SQLAlchemyError` 用于捕获 SQLAlchemy 特有的错误。

## 步骤 2：读取数据库连接信息

```python
database_uri = os.environ.get('DATABASE_URI')
if not database_uri:
    raise ValueError("未找到环境变量'DATABASE_URI'，请检查环境变量设置。")
```

- `DATABASE_URI` 存储在系统环境变量中，用于指定 MySQL 数据库的 URI。如果没有找到该环境变量，程序会报错并终止。

## 步骤 3：建立数据库连接

```python
try:
    engine = create_engine(database_uri)
    print("数据库连接已建立。")
except SQLAlchemyError as e:
    print("数据库连接失败:", e)
    exit()
```

- 使用 `create_engine(database_uri)` 创建与数据库的连接。
- 如果连接失败，会捕获异常 `SQLAlchemyError` 并打印错误信息。

## 步骤 4：遍历 CSV 文件并读取数据

```python
folder_path = "C:\Users\86138\Desktop\RouteMate\DataSets"  
for file_name in os.listdir(folder_path):
    if file_name.endswith('.csv'):
```

- 使用 `os.listdir(folder_path)` 列出指定文件夹中的所有文件，并过滤出以 `.csv` 结尾的文件。

## 步骤 5：提取用户 ID 和读取 CSV 文件

```python
user_id = int(file_name.split('_')[1])  
file_path = os.path.join(folder_path, file_name)
data = pd.read_csv(file_path)
```

- 通过解析文件名提取 `user_id`。
- 使用 `pandas` 读取 CSV 文件的数据。

## 步骤 6：验证数据格式

```python
if not all(column in data.columns for column in ['latitude', 'longitude', 'timestamp']):
    raise ValueError(f"文件 {file_name} 缺少必要的列。")
```

- 确保数据中包含 `latitude`、`longitude` 和 `timestamp` 列。

## 步骤 7：转换数据为 JSON 格式

```python
trajectory_data = data[['latitude', 'longitude', 'timestamp']].to_dict(orient='records')
json_data = json.dumps(trajectory_data)
```

- 使用 `to_dict` 将数据转换为字典列表，再使用 `json.dumps` 转换为 JSON 字符串。

## 步骤 8：插入数据到数据库

```python
insert_query = f'''
INSERT INTO Trajectory (user_id, trajectory_data)
VALUES ({user_id}, '{json_data}');
'''
with engine.connect() as connection:
    connection.execute(insert_query)
```

- `insert_query` 中的 SQL 语句将用户的 ID 和轨迹数据插入到 `Trajectory` 表中。
- 使用 `engine.connect()` 打开数据库连接，并执行插入操作。

## 错误处理

代码中包含多种错误处理机制，如 `FileNotFoundError`、`ValueError` 和 `SQLAlchemyError`，用来捕获文件、数据格式和数据库操作中可能出现的异常。



